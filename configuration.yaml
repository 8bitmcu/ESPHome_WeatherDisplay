sensor:
  - platform: rest
    name: "Open Meteo Raw"
    unique_id: open_meteo_raw
    resource: "https://api.open-meteo.com/v1/forecast?latitude=LATITUDE&longitude=LONGITUDE&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max,sunrise,sunset,surface_pressure_mean&hourly=temperature_2m,precipitation,precipitation_probability,weather_code,wind_speed_10m&current=temperature_2m,relative_humidity_2m&timezone=auto&models=gem_seamless"
    scan_interval: 900
    value_template: "{{ value_json.current.temperature_2m }}"
    json_attributes:
      - current
      - daily
      - hourly

template:
  - sensor:
      - name: "Weather Bundle JSON"
        unique_id: weather_bundle_json
        state: "OK"
        attributes:
          data: >
            {% set raw = states.sensor.open_meteo_raw.attributes %}
            {% if raw is defined and raw.daily is defined %}
              {% set res = namespace(all={}) %}

              {# 1. Current Data #}
              {% set res.all = {
                "cur_t": raw.current.temperature_2m | string,
                "cur_h": raw.current.relative_humidity_2m | string,
                "d0_sunr": (raw.daily.sunrise[0] | as_datetime | default(now())).strftime('%H:%M'),
                "d0_suns": (raw.daily.sunset[0] | as_datetime | default(now())).strftime('%H:%M'),
                "d0_pres": raw.daily.surface_pressure_mean[0] | string,
                "updated": now().strftime('%H:%M')
              } %}

              {# 2. Daily Forecast #}
              {% for i in range(7) %}
                {% set day_data = {
                  'd'~i~'_t': (raw.daily.time[i] | as_datetime | default(now())).strftime('%a'),
                  'd'~i~'_tp': (raw.daily.temperature_2m_max[i] | round(1) | string) ~ "/" ~ (raw.daily.temperature_2m_min[i] | round(1) | string),
                  'd'~i~'_pr': raw.daily.precipitation_sum[i] | string,
                  'd'~i~'_wd': raw.daily.wind_speed_10m_max[i] | string,
                  'd'~i~'_c': raw.daily.weather_code[i] | int
                } %}
                {% set res.all = dict(res.all, **day_data) %}
              {% endfor %}

              {# 3. Hourly Forecast #}
              {% set current_hour_str = now().strftime('%Y-%m-%dT%H:00') %}
              {% set start_index = namespace(value=0) %}
              {% for t in raw.hourly.time %}
                {% if t.startswith(current_hour_str) %}
                  {% set start_index.value = loop.index0 %}
                {% endif %}
              {% endfor %}
              {% for i in range(18) %}
                {% set idx = start_index.value + i %}
                {% if idx < raw.hourly.time | length %}
                  {% set hr_data = {
                    'h'~i~'_t': (raw.hourly.time[idx] | as_datetime | default(now())).strftime('%H:%M'),
                    'h'~i~'_tp': raw.hourly.temperature_2m[idx] | string,
                    'h'~i~'_pa': raw.hourly.precipitation[idx] | string,
                    'h'~i~'_pp': raw.hourly.precipitation_probability[idx] | string,
                    'h'~i~'_wd': raw.hourly.wind_speed_10m[idx] | string,
                    'h'~i~'_c': raw.hourly.weather_code[idx] | int
                  } %}
                  {% set res.all = dict(res.all, **hr_data) %}
                {% endif %}
              {% endfor %}

              {{ res.all | to_json }}
            {% else %}
              {"error": "waiting_for_sensor"}
            {% endif %}
