text_sensor:
  - platform: homeassistant
    id: weather_data
    entity_id: sensor.weather_bundle_json
    attribute: data
    on_value:
      then:
        - lambda: |-
            parse_json(x, [](JsonObject root) -> bool {
              if (root.isNull()) return false;

              auto update_fmt = [&](lv_obj_t* obj, const char* key, const char* unit) {
                if (root[key].is<const char*>()) {
                  lv_label_set_text_fmt(obj, "%s%s", root[key].as<const char*>(), unit);
                }
              };

              update_fmt(id(lbl_day0_curtemp), "cur_t", "°C");
              update_fmt(id(lbl_day0_curhum),  "cur_h", "%");
              update_fmt(id(lbl_day0_sunr),    "d0_sunr", ""); // No unit for time
              update_fmt(id(lbl_day0_suns),    "d0_suns", "");
              update_fmt(id(lbl_day0_pres),    "d0_pres", " hPa");

              lv_obj_t* day_times[] = {nullptr, id(lbl_day1_time), id(lbl_day2_time), id(lbl_day3_time), id(lbl_day4_time), id(lbl_day5_time), id(lbl_day6_time)};
              lv_obj_t* day_temps[] = {id(lbl_day0_temp), id(lbl_day1_temp), id(lbl_day2_temp), id(lbl_day3_temp), id(lbl_day4_temp), id(lbl_day5_temp), id(lbl_day6_temp)};
              lv_obj_t* day_pres[]  = {id(lbl_day0_pre),  id(lbl_day1_pre),  id(lbl_day2_pre),  id(lbl_day3_pre),  id(lbl_day4_pre),  id(lbl_day5_pre),  id(lbl_day6_pre)};
              lv_obj_t* day_winds[] = {id(lbl_day0_wind), id(lbl_day1_wind), id(lbl_day2_wind), id(lbl_day3_wind), id(lbl_day4_wind), id(lbl_day5_wind), id(lbl_day6_wind)};
              lv_obj_t* day_conds[] = {id(lbl_day0_cond), id(lbl_day1_cond), id(lbl_day2_cond), id(lbl_day3_cond), id(lbl_day4_cond), id(lbl_day5_cond), id(lbl_day6_cond)};
              lv_obj_t* day_imgs[]  = {id(img_day0_code), id(img_day1_code), id(img_day2_code), id(img_day3_code), id(img_day4_code), id(img_day5_code), id(img_day6_code)};

              for (int i = 0; i < 7; i++) {
                std::string prefix = "d" + std::to_string(i);

                if (day_times[i] != nullptr) update_fmt(day_times[i], (prefix + "_t").c_str(), "");
                update_fmt(day_temps[i], (prefix + "_tp").c_str(), "°");
                update_fmt(day_pres[i],  (prefix + "_pr").c_str(), " cm");
                update_fmt(day_winds[i], (prefix + "_wd").c_str(), " kph");

                std::string c_key = prefix + "_c";
                if (root[c_key].is<int>()) {
                  std::string c_str = std::to_string(root[c_key].as<int>());
                  lv_label_set_text(day_conds[i], weather_text[c_str].c_str());
                  lv_img_set_src(day_imgs[i], id(weather_icon)[c_str]);
                }
              }

              lv_obj_t* hr_times[] = {id(lbl_hour0_time), id(lbl_hour1_time), id(lbl_hour2_time), id(lbl_hour3_time), id(lbl_hour4_time), id(lbl_hour5_time), id(lbl_hour6_time), id(lbl_hour7_time), id(lbl_hour8_time), id(lbl_hour9_time), id(lbl_hour10_time), id(lbl_hour11_time), id(lbl_hour12_time), id(lbl_hour13_time), id(lbl_hour14_time), id(lbl_hour15_time), id(lbl_hour16_time), id(lbl_hour17_time)};
              lv_obj_t* hr_temps[] = {id(lbl_hour0_temp), id(lbl_hour1_temp), id(lbl_hour2_temp), id(lbl_hour3_temp), id(lbl_hour4_temp), id(lbl_hour5_temp), id(lbl_hour6_temp), id(lbl_hour7_temp), id(lbl_hour8_temp), id(lbl_hour9_temp), id(lbl_hour10_temp), id(lbl_hour11_temp), id(lbl_hour12_temp), id(lbl_hour13_temp), id(lbl_hour14_temp), id(lbl_hour15_temp), id(lbl_hour16_temp), id(lbl_hour17_temp)};
              lv_obj_t* hr_accs[]  = {id(lbl_hour0_preacc), id(lbl_hour1_preacc), id(lbl_hour2_preacc), id(lbl_hour3_preacc), id(lbl_hour4_preacc), id(lbl_hour5_preacc), id(lbl_hour6_preacc), id(lbl_hour7_preacc), id(lbl_hour8_preacc), id(lbl_hour9_preacc), id(lbl_hour10_preacc), id(lbl_hour11_preacc), id(lbl_hour12_preacc), id(lbl_hour13_preacc), id(lbl_hour14_preacc), id(lbl_hour15_preacc), id(lbl_hour16_preacc), id(lbl_hour17_preacc)};
              lv_obj_t* hr_probs[] = {id(lbl_hour0_preprob), id(lbl_hour1_preprob), id(lbl_hour2_preprob), id(lbl_hour3_preprob), id(lbl_hour4_preprob), id(lbl_hour5_preprob), id(lbl_hour6_preprob), id(lbl_hour7_preprob), id(lbl_hour8_preprob), id(lbl_hour9_preprob), id(lbl_hour10_preprob), id(lbl_hour11_preprob), id(lbl_hour12_preprob), id(lbl_hour13_preprob), id(lbl_hour14_preprob), id(lbl_hour15_preprob), id(lbl_hour16_preprob), id(lbl_hour17_preprob)};
              lv_obj_t* hr_winds[] = {id(lbl_hour0_wind), id(lbl_hour1_wind), id(lbl_hour2_wind), id(lbl_hour3_wind), id(lbl_hour4_wind), id(lbl_hour5_wind), id(lbl_hour6_wind), id(lbl_hour7_wind), id(lbl_hour8_wind), id(lbl_hour9_wind), id(lbl_hour10_wind), id(lbl_hour11_wind), id(lbl_hour12_wind), id(lbl_hour13_wind), id(lbl_hour14_wind), id(lbl_hour15_wind), id(lbl_hour16_wind), id(lbl_hour17_wind)};
              lv_obj_t* hr_imgs[]  = {id(img_hour0_code), id(img_hour1_code), id(img_hour2_code), id(img_hour3_code), id(img_hour4_code), id(img_hour5_code), id(img_hour6_code), id(img_hour7_code), id(img_hour8_code), id(img_hour9_code), id(img_hour10_code), id(img_hour11_code), id(img_hour12_code), id(img_hour13_code), id(img_hour14_code), id(img_hour15_code), id(img_hour16_code), id(img_hour17_code)};

              for (int i = 0; i < 18; i++) {
                std::string prefix = "h" + std::to_string(i);
                update_fmt(hr_times[i], (prefix + "_t").c_str(), "");
                update_fmt(hr_temps[i], (prefix + "_tp").c_str(), "°");
                update_fmt(hr_accs[i],  (prefix + "_pa").c_str(), " cm");
                update_fmt(hr_probs[i], (prefix + "_pp").c_str(), "%");
                update_fmt(hr_winds[i], (prefix + "_wd").c_str(), " kph");

                std::string h_key = prefix + "_c";
                if (root[h_key].is<int>()) {
                  std::string c_str = std::to_string(root[h_key].as<int>());
                  lv_img_set_src(hr_imgs[i], id(weather_icon)[c_str]);
                }
              }

              if (root["updated"].is<const char*>()) {
                lv_label_set_text_fmt(id(lbl_last_update), "Updated: %s", root["updated"].as<const char*>());
              }

              return true;
            });
